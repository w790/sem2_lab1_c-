name: C++ build and release # Название нашего процесса

on:
  push: # При любом пуше (заливке кода) в репозиторий
    branches:
        - main # Запускаться только если пушим в ветку main

jobs:
  build-ubuntu: 
    runs-on: ubuntu-latest # ОС: последняя Ubuntu
    permissions: write-all
    steps: 
       - uses: actions/checkout@v4 # 1. Клонируем наш код
       - run: cmake -B ${{github.workspace}}/build -DCMAKE_BUILD_TYPE=Release # 2. Настраиваем CMake
       - run: cmake --build ${{github.workspace}}/build --config Release # 3. Собираем проект
       - uses: actions/upload-artifact@v4 # 4. Сохраняем результат сборки
         with:
          name: hello-world-ubuntu
          path: ${{github.workspace}}/build/hello_world

  build-windows:
    runs-on: windows-latest 
    steps:
       - uses: actions/checkout@v4
       - run: cmake -B ${{github.workspace}}/build
       - run: cmake --build ${{github.workspace}}/build --config Release
       - uses: actions/upload-artifact@v4
         with:
          name: hello-world-windows
          path: ${{github.workspace}}/build/Release/hello_world.exe

  create-release: # Задача №3: Создание релиза
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-ubuntu, build-windows] # Ждем, пока обе сборки успешно завершатся
    if: github.ref == 'refs/heads/main' # Делаем релиз только с ветки main

    steps:
      - name: Download all artifacts # Скачиваем все собранные артефакты
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts  # Скачиваем все артефакты в папку ./artifacts

      - name: List files # Посмотрим, что скачалось (для отладки)
        run: ls -R ./artifacts

      - name: Create Release # Создаем релиз на GitHub
        uses: softprops/action-gh-release@v1
        with:
          files: | # Перечисляем файлы, которые надо добавить в релиз
            ./artifacts/hello-world-ubuntu/hello_world
            ./artifacts/hello-world-windows/hello_world.exe
          tag_name: v1.0.${{ github.run_number }} # Версия = 1.0.НОМЕР_СБОРКИ
          name: Release v1.0.${{ github.run_number }}
          body: Автоматический релиз сборки №${{ github.run_number }}